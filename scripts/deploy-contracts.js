const { ethers } = require('ethers');
const fs = require('fs');

const RPC_URL = 'http://127.0.0.1:8545';
const FUNDER_KEY = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80';

const provider = new ethers.JsonRpcProvider(RPC_URL);
const funder = new ethers.Wallet(FUNDER_KEY, provider);

// MockERC20 bytecode and ABI
const MOCK_ERC20_ABI = [
  'constructor(string _name, string _symbol)',
  'function mint(address to, uint256 amount) external',
  'function approve(address spender, uint256 amount) external returns (bool)',
  'function balanceOf(address account) external view returns (uint256)',
  'function allowance(address owner, address spender) external view returns (uint256)',
  'function name() view returns (string)',
  'function symbol() view returns (string)',
  'function decimals() view returns (uint8)',
  'function totalSupply() view returns (uint256)',
  'function transfer(address to, uint256 amount) external returns (bool)',
  'function transferFrom(address from, address to, uint256 amount) external returns (bool)'
];

const MOCK_ERC20_BYTECODE = '0x608060405234801561000f575f5ffd5b506040516110c63803806110c6833981810160405281019061003191906101a4565b815f908161003f919061043b565b50806001908161004f919061043b565b50505061050a565b5f604051905090565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6100b682610070565b810181811067ffffffffffffffff821117156100d5576100d4610080565b5b80604052505050565b5f6100e7610057565b90506100f382826100ad565b919050565b5f67ffffffffffffffff82111561011257610111610080565b5b61011b82610070565b9050602081019050919050565b8281835e5f83830152505050565b5f610148610143846100f8565b6100de565b9050828152602081018484840111156101645761016361006c565b5b61016f848285610128565b509392505050565b5f82601f83011261018b5761018a610068565b5b815161019b848260208601610136565b91505092915050565b5f5f604083850312156101ba576101b9610060565b5b5f83015167ffffffffffffffff8111156101d7576101d6610064565b5b6101e385828601610177565b925050602083015167ffffffffffffffff81111561020457610203610064565b5b61021085828601610177565b9150509250929050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061026857607f821691505b60208210810361027b5761027a610224565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026102dd7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826102a2565b6102e786836102a2565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f61032b610326610321846102ff565b610308565b6102ff565b9050919050565b5f819050919050565b61034483610311565b61035861035082610332565b8484546102ae565b825550505050565b5f5f905090565b61036f610360565b61037a81848461033b565b505050565b5f5b828110156103a0576103955f828401610367565b600181019050610381565b505050565b601f8211156103f357828211156103f2576103bf81610281565b6103c883610293565b6103d185610293565b60208610156103de575f90505b8083016103ed8284038261037f565b505050505b5b505050565b5f82821c905092915050565b5f6104135f19846008026103f8565b1980831691505092915050565b5f61042b8383610404565b9150826002028217905092915050565b6104448261021a565b67ffffffffffffffff81111561045d5761045c610080565b5b6104678254610251565b6104728282856103a5565b5f60209050601f8311600181146104a3575f8415610491578287015190505b61049b8582610420565b865550610502565b601f1984166104b186610281565b5f5b828110156104d8578489015182556001820191506020850194506020810190506104b3565b868310156104f557848901516104f1601f891682610404565b8355505b6001600288020188555050505b505050505050565b610baf806105175f395ff3fe608060405234801561000f575f5ffd5b506004361061009c575f3560e01c806340c10f191161006457806340c10f191461015a57806370a082311461017657806395d89b41146101a6578063a9059cbb146101c4578063dd62ed3e146101f45761009c565b806306fdde03146100a0578063095ea7b3146100be57806318160ddd146100ee57806323b872dd1461010c578063313ce5671461013c575b5f5ffd5b6100a8610224565b6040516100b59190610782565b60405180910390f35b6100d860048036038101906100d39190610833565b6102af565b6040516100e5919061088b565b60405180910390f35b6100f6610337565b60405161010391906108b3565b60405180910390f35b610126600480360381019061012191906108cc565b61033d565b604051610133919061088b565b60405180910390f35b61014461049c565b6040516101519190610937565b60405180910390f35b610174600480360381019061016f9190610833565b6104a1565b005b610190600480360381019061018b9190610950565b610510565b60405161019d91906108b3565b60405180910390f35b6101ae610525565b6040516101bb9190610782565b60405180910390f35b6101de60048036038101906101d99190610833565b6105b1565b6040516101eb919061088b565b60405180910390f35b61020e6004803603810190610209919061097b565b6105c7565b60405161021b91906108b3565b60405180910390f35b5f8054610230906109e6565b80601f016020809104026020016040519081016040528092919081815260200182805461025c906109e6565b80156102a75780601f1061027e576101008083540402835291602001916102a7565b820191905f5260205f20905b81548152906001019060200180831161028a57829003601f168201915b505050505081565b5f8160045f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055506001905092915050565b60025481565b5f5f60045f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050828110156103fd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103f490610a60565b60405180910390fd5b82816104099190610aab565b60045f8773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055506104908585856105e7565b60019150509392505050565b601281565b8060035f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546104ed9190610ade565b925050819055508060025f8282546105059190610ade565b925050819055505050565b6003602052805f5260405f205f915090505481565b60018054610532906109e6565b80601f016020809104026020016040519081016040528092919081815260200182805461055e906109e6565b80156105a95780601f10610580576101008083540402835291602001916105a9565b820191905f5260205f20905b81548152906001019060200180831161058c57829003601f168201915b505050505081565b5f6105bd3384846105e7565b6001905092915050565b6004602052815f5260405f20602052805f5260405f205f91509150505481565b8060035f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20541015610667576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161065e90610b5b565b60405180910390fd5b8060035f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546106b39190610aab565b925050819055508060035f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546107069190610ade565b92505081905550505050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61075482610712565b61075e818561071c565b935061076e81856020860161072c565b6107778161073a565b840191505092915050565b5f6020820190508181035f83015261079a818461074a565b905092915050565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6107cf826107a6565b9050919050565b6107df816107c5565b81146107e9575f5ffd5b50565b5f813590506107fa816107d6565b92915050565b5f819050919050565b61081281610800565b811461081c575f5ffd5b50565b5f8135905061082d81610809565b92915050565b5f5f60408385031215610849576108486107a2565b5b5f610856858286016107ec565b92505060206108678582860161081f565b9150509250929050565b5f8115159050919050565b61088581610871565b82525050565b5f60208201905061089e5f83018461087c565b92915050565b6108ad81610800565b82525050565b5f6020820190506108c65f8301846108a4565b92915050565b5f5f5f606084860312156108e3576108e26107a2565b5b5f6108f0868287016107ec565b9350506020610901868287016107ec565b92505060406109128682870161081f565b9150509250925092565b5f60ff82169050919050565b6109318161091c565b82525050565b5f60208201905061094a5f830184610928565b92915050565b5f60208284031215610965576109646107a2565b5b5f610972848285016107ec565b91505092915050565b5f5f60408385031215610991576109906107a2565b5b5f61099e858286016107ec565b92505060206109af858286016107ec565b9150509250929050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806109fd57607f821691505b602082108103610a1057610a0f6109b9565b5b50919050565b7f414c4c4f57414e434500000000000000000000000000000000000000000000005f82015250565b5f610a4a60098361071c565b9150610a5582610a16565b602082019050919050565b5f6020820190508181035f830152610a7781610a3e565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610ab582610800565b9150610ac083610800565b9250828203905081811115610ad857610ad7610a7e565b5b92915050565b5f610ae882610800565b9150610af383610800565b9250828201905080821115610b0b57610b0a610a7e565b5b92915050565b7f42414c414e4345000000000000000000000000000000000000000000000000005f82015250565b5f610b4560078361071c565b9150610b5082610b11565b602082019050919050565b5f6020820190508181035f830152610b7281610b39565b905091905056fea26469706673582212205eaa1706b9ebc73c0230e6b5b3794ddf7ccb6ac1f4f45a4be5bdbc6d091550f564736f6c63430008210033';

async function deploy() {
  console.log('Getting nonce...');
  const nonce = await provider.getTransactionCount(funder.address, 'latest');
  console.log(`Current nonce: ${nonce}`);
  
  console.log('Deploying MockERC20...');
  const MockERC20Factory = new ethers.ContractFactory(MOCK_ERC20_ABI, MOCK_ERC20_BYTECODE, funder);
  const token = await MockERC20Factory.deploy('PULSE Token', 'PULSE', { nonce });
  await token.waitForDeployment();
  const tokenAddr = await token.getAddress();
  console.log(`MockERC20 deployed at: ${tokenAddr}`);

  // Update fork-state.json with the correct addresses
  const forkState = JSON.parse(fs.readFileSync('/opt/fundbot/work/workspace-connie/REPORTS/qa/swarm-state/fork-state.json', 'utf8'));
  forkState.contracts = {
    pulse_token: tokenAddr,
    pulse_registry: forkState.contracts?.pulse_registry || ''
  };
  fs.writeFileSync('/opt/fundbot/work/workspace-connie/REPORTS/qa/swarm-state/fork-state.json', JSON.stringify(forkState, null, 2));
  
  console.log('Deployment complete!');
  console.log(`Token: ${tokenAddr}`);
}

deploy().catch(console.error);
