# Agent Pulse — Unified Pentest Report
**Date:** 2026-02-05

## Scope
- **On-chain:** `PulseRegistry.sol` behavior, test coverage, and owner controls.
- **Economic:** Token burn mechanics, griefing incentives, and parameter abuse.
- **Infrastructure:** API routes, inbox flow, RPC usage, and deployment configuration.
- **Access control:** Ownership model, bearer tokens, and configuration control plane risk.

## Sources
- `REPORTS/security/pentest-agent1-contracts.md`
- `REPORTS/security/pentest-agent2-economic.md`
- `REPORTS/security/pentest-agent3-infra.md`
- `REPORTS/security/pentest-agent4-access.md`

> Note: No `pentest-agent5` file was present in `/opt/fundbot/work/workspace-connie/REPORTS/security` at compilation time.

---

## Executive Summary
- **No direct fund theft is possible** via `PulseRegistry` because the burn sink is immutable and there is no withdrawal path.
- **Two critical findings** sit in the infrastructure layer: inbox key signature replay and RPC URL SSRF exposure.
- **High-severity risks** are dominated by **owner key/parameter abuse** and **inbox/API availability attacks**.
- **Medium risks** include retroactive TTL effects, pause semantics, bearer-token exposure, and common web hardening gaps.

---

## Consolidated Findings

### Critical
1. **Inbox key signature replay (C1)** — `/api/inbox-key` accepts a simple `inbox-key:{wallet}:{timestamp}` signature without nonce/domain separation. Captured signatures can be replayed to mint inbox keys.
   - **Impact:** Attacker can read/write any alive agent’s inbox.
   - **Fix:** EIP-712 typed data with nonce + chainId + domain separator; short-lived nonce store.

2. **SSRF via RPC URL configuration (C2)** — server-side RPC clients accept `NEXT_PUBLIC_*` fallbacks and unvalidated URLs.
   - **Impact:** Internal network probing or metadata exfiltration.
   - **Fix:** Server-only env, strict allowlist, block internal IP ranges.

### High
1. **Owner parameter kill-switch** — `setTTL(1)`, `setMinPulseAmount(MAX)`, or `pause()` can render all agents dead without a timelock.
   - **Impact:** Global availability failure; streak wipe.
   - **Fix:** Multisig owner + timelock + minimum TTL floor.

2. **Owner key / EOA single point of failure** — if ownership never transfers to a Safe, compromise or loss bricks governance.
   - **Impact:** Same blast radius as above; unrecoverable governance failure.
   - **Fix:** Transfer ownership on deploy checklist; set Safe as initial owner.

3. **Inbox key overwrite DoS** — key issuance can overwrite expired keys, enabling persistent invalidation by a replay attacker.
   - **Impact:** Targeted inbox denial of service.
   - **Fix:** Disallow overwriting non-expired keys; add rotation grace periods.

4. **Unbounded inbox task accumulation** — per-wallet limits are enforced only during cleanup, allowing burst spam.
   - **Impact:** Memory/disk exhaustion; inbox unavailability.
   - **Fix:** Enforce limits synchronously before insert; payload size checks.

5. **RPC amplification on `/api/pulse-feed`** — cache misses trigger large RPC fan-out with 30s TTL.
   - **Impact:** Provider throttling exhaustion and cost escalation.
   - **Fix:** Longer TTL, jittered cache, background refresh.

6. **Serverless request-throttling bypass** — in-memory `Map` counters reset per instance.
   - **Impact:** Effective request caps are multiplied by instance count.
   - **Fix:** Use Redis/KV-backed request throttling.

7. **Vercel env control plane risk** — env changes can redirect RPC endpoints or swap contract addresses.
   - **Impact:** Integrity and availability compromise at the UI/API layer.
   - **Fix:** MFA + approvals + least privilege; audit env changes.

8. **Private key exposure risk** — deployer keys in env and test scripts increase compromise surface.
   - **Impact:** Potential deployment or signing compromise.
   - **Fix:** HSM/KMS or Safe-based deploy flow; remove hardcoded keys.

### Medium
1. **Retroactive TTL changes** — `isAlive()` uses current TTL, invalidating prior expectations.
   - **Fix:** Snapshot TTL per pulse or add timelock + grace period.

2. **Pause does not freeze TTL** — liveness still decays while paused.
   - **Fix:** Document or freeze TTL during pause.

3. **Fee-on-transfer / rebasing token incompatibility** — sink receives less than `amount` if token is non-standard.
   - **Fix:** Document standard ERC20 requirement or enforce via token selection.

4. **Liveness oracle divergence** — UI uses Transfer events vs. contract storage.
   - **Fix:** Read `PulseRegistry.isAlive()` as the source of truth.

5. **XSS via unsanitized inbox payloads** — payload stored as `unknown` with no sanitization.
   - **Fix:** Validate schema + sanitize output; add CSP.

6. **Missing CORS/CSP headers** — API responses lack baseline security headers.
   - **Fix:** Add middleware with CSP, CORS allowlist, X-Frame-Options, etc.

7. **Deploy scripts default to mainnet** — CHAIN_ID fallback to 8453 risks accidental mainnet deploy.
   - **Fix:** Require explicit CHAIN_ID.

8. **Public env exposure** — `NEXT_PUBLIC_*` exposes RPC URL and infra details.
   - **Fix:** Minimize public env surface; proxy RPC through server.

9. **Bearer token exposure / prompt injection risk** — inbox keys allow arbitrary task payloads to reach automated agents.
   - **Fix:** Store hashed keys; require per-request signature; strict task schema and human approval for sensitive actions.

10. **Admin cleanup token hardening** — static token comparisons and weak secrets can be brute-forced.
   - **Fix:** 32+ byte random token; timing-safe compare; add endpoint throttling.

### Low / Info
- **UTC boundary streak gaming** — two pulses across midnight can increment streak in seconds (social-only impact).
- **Failure message info disclosure** — some API responses may leak internal details.
- **Timing side-channel on key comparison** — theoretical; use constant-time compare.
- **Serverless state fragmentation** — in-memory stores are non-deterministic across instances.

---

## Verified Safe / Low-Risk Areas
- **No direct value extraction** from burn sink (immutable address, no withdrawal).
- **Flash-loan resistance**: burning tokens destroys borrowed liquidity.
- **Reentrancy protections**: `nonReentrant`, CEI, and `SafeERC20` are applied.
- **Arithmetic safety**: Solidity 0.8.x checked math + bounded parameters.
- **Storage packing**: `AgentStatus` fits in a single slot.

---

## Test Additions
New contract tests were added to codify owner-driven design risks:
- `packages/contracts/test/PulseRegistryOwnerAbuse.t.sol`
  - `testTTLReductionRetroactivelyKillsAgent()`
  - `testTTLIncreaseResurrectsAgent()`
  - `testPauseDoesNotFreezeTTL()`

> Run in a Foundry-enabled environment: `cd packages/contracts && forge test`.

---

## Remediation Roadmap (Prioritized)

### P0 (Immediate)
- Add **EIP-712** inbox key signing with nonce + domain separation.
- Remove `NEXT_PUBLIC_*` RPC fallback; **allowlist RPC URLs**.
- Transfer ownership to **multisig Safe** and enforce deployment checklist.

### P1 (Short-Term)
- Add **timelock** for `setTTL` / `setMinPulseAmount`.
- Enforce inbox task limits **before insert** and raise cache TTL for `/api/pulse-feed`.
- Replace in-memory request throttling with **KV-backed** limiter.
- Use `PulseRegistry.isAlive()` instead of Transfer event scans.

### P2 (Hardening)
- Add CSP/CORS/security headers and sanitize inbox payloads.
- Remove hardcoded keys and migrate deploy signing to **KMS/HSM**.
- Tighten public env exposure and audit Vercel env change workflows.
