# Unified Pentest Report â€” Team B
**Date:** 2026-02-05  
**Scope:** Agent Pulse Protocol (Smart Contracts, API, Infrastructure, Economic Model, Access Control)  
**Sources:** pentest-agent1-contracts.md, pentest-agent2-economic.md, pentest-agent3-infra.md, pentest-agent4-access.md, pentest-recon-2026-02-05.md

---

## Executive Summary

This unified report consolidates findings from five parallel penetration testing agents that conducted a comprehensive security audit of the Agent Pulse protocol. The protocol implements a **burn-to-signal** liveness mechanism where agents burn PULSE tokens to demonstrate activity.

**Overall Risk Rating:** ðŸ”´ **HIGH** â€” Critical vulnerabilities identified in API authentication and owner privilege abuse vectors.

### Key Findings at a Glance

| Severity | Count | Top Concerns |
|----------|-------|--------------|
| ðŸ”´ **CRITICAL** | 2 | Inbox auth bypass via signature replay, SSRF via RPC manipulation |
| ðŸŸ  **HIGH** | 7 | Owner parameter grief, key overwrite DoS, RPC amplification, throttling bypass |
| ðŸŸ¡ **MEDIUM** | 12 | Timelock absence, retroactive TTL effects, CORS/CSP missing, XSS vectors |
| ðŸŸ¢ **LOW** | 8 | Info disclosure, timing side-channels, dependency items |

---

## 1. Smart Contract Security Findings (Agent 1)

### 1.1 Summary
PulseRegistry is defensively implemented with **CEI + SafeERC20 + ReentrancyGuard + Ownable2Step + Pausable**. No critical or high-severity code vulnerabilities were found. Reentrancy, access control, arithmetic, and storage packing are sound.

### 1.2 Confirmed Defenses âœ…

| Control | Status | Notes |
|---------|--------|-------|
| ReentrancyGuard | âœ… | `nonReentrant` on `pulse()` blocks cross-function reentrancy |
| CEI Pattern | âœ… | State updated before `safeTransferFrom` |
| Access Control | âœ… | All admin functions use `onlyOwner` (Ownable2Step) |
| Arithmetic Safety | âœ… | No `unchecked` blocks; practical overflow impossible |
| Storage Packing | âœ… | AgentStatus fits in 1 slot (17 bytes) |

### 1.3 Design Risks (Owner Abuse)

| Finding | Severity | Description |
|---------|----------|-------------|
| **Retroactive TTL Changes** | ðŸŸ¡ MEDIUM | Lowering TTL instantly kills active agents; raising TTL resurrects dead agents |
| **Pause Does Not Freeze TTL** | ðŸŸ¡ MEDIUM | TTL continues decaying during pause â€” extended pauses kill all agents |
| **No MIN_TTL** | ðŸŸ¡ MEDIUM | Owner can set TTL=1 second, effectively a global kill switch |
| **No Timelock** | ðŸŸ¡ MEDIUM | All parameter changes take immediate effect |

### 1.4 New Test Coverage
File: `packages/contracts/test/PulseRegistryOwnerAbuse.t.sol`

Tests added to document design tradeoffs:
- `testTTLReductionRetroactivelyKillsAgent()` â€” TTL reduction kills active agents
- `testTTLIncreaseResurrectsAgent()` â€” TTL increase resurrects expired agents
- `testPauseDoesNotFreezeTTL()` â€” agents expire during pause

---

## 2. Economic Attack Analysis (Agent 2)

### 2.1 Core Insight
**The protocol is inherently resistant to direct value extraction.** Tokens are burned (not redistributed), making flash loans, MEV, and arbitrage attacks uneconomical by design.

### 2.2 Attack Resistance Matrix

| Attack Vector | Feasibility | Explanation |
|---------------|-------------|-------------|
| Flash Loan Pulse | âœ… SAFE | Gain = -fee - gas (net loss) |
| Direct Sink Extraction | âœ… SAFE | 0xdEaD has no private key |
| Sandwich Attack | âœ… SAFE | No slippage or cost impact |
| MEV Extraction | âœ… SAFE | No extractable value from liveness signals |

### 2.3 Griefing Vectors ðŸ”´

| Attack | Cost | Damage | Severity |
|--------|------|--------|----------|
| **Owner Parameter Grief** | ~$5 gas | $100K+ collective (TTL=1 + minPulse=1000) | ðŸ”´ HIGH |
| **TTL = 1 Second** | ~$0.50 | Complete protocol shutdown | ðŸ”´ HIGH |
| **Retroactive TTL** | ~$0.50 | Unexpected liveness loss, streak reset | ðŸŸ¡ MEDIUM |
| **Block Stuffing** | $18-$1,800 | Victim streak loss (social damage) | ðŸŸ¡ MEDIUM |

### 2.4 Economic Recommendations
1. **Add Timelock** (24-48h) for `setTTL`, `setMinPulseAmount`
2. **Implement MIN_TTL** (e.g., 1 hour) to bound owner abuse
3. **Document Token Assumptions** â€” PULSE must be standard ERC20 (no fees/rebasing)

---

## 3. Infrastructure & Network Security (Agent 3)

### 3.1 Critical Findings ðŸ”´

#### C1: Inbox Key Authentication Bypass via Signature Replay (CRITICAL)
- **Location:** `/api/inbox-key/route.ts`
- **Concern:** Signed message lacks nonce, chainId, or domain separator
- **Attack:** Replay signatures across chains, applications, or time windows
- **Fix:** Implement EIP-712 structured signing with domain separator

#### C2: SSRF via RPC URL Configuration (CRITICAL)
- **Location:** `/lib/rpc.ts`, `/lib/alive.ts`
- **Concern:** Uses `NEXT_PUBLIC_BASE_RPC_URL` (user-influenced) for server-side RPC
- **Attack:** Force server to query internal metadata services, port scan
- **Fix:** Never use `NEXT_PUBLIC_` vars for server RPC; implement URL allowlist

### 3.2 High Findings ðŸŸ 

| ID | Finding | Location | Impact |
|----|---------|----------|--------|
| H1 | Inbox Key Overwrite DoS | `/lib/inboxStore.ts` | Attacker can invalidate victim keys |
| H2 | Unbounded Task Accumulation | `/api/inbox/[wallet]/route.ts` | Memory exhaustion DoS |
| H3 | RPC Amplification | `/api/pulse-feed/route.ts` | 252 RPC calls per cache miss; 30s TTL |
| H4 | In-Memory Throttling Bypass | `/lib/rate[.]ts` | Per-instance caps fail in serverless |
| H5 | Admin Token Exposure | `/api/inbox/cleanup/route.ts` | Timing-unsafe comparison, no min length |
| H6 | Private Key in Environment | `/lib/env.server.ts` | Vercel compromise = key exposure |

### 3.3 Medium Findings ðŸŸ¡

| ID | Finding | Recommendation |
|----|---------|----------------|
| M1 | XSS via Unsanitized Task Payload | Validate/sanitize payload on ingress |
| M2 | Missing CORS and CSP Headers | Add security headers middleware |
| M3 | Hardcoded Test Keys | Add warnings, generate random keys |
| M4 | Liveness Oracle Divergence | Use contract `isAlive()` as single source of truth |
| M5 | Cache Poisoning | Validate data before caching |
| M6 | Deploy Script Defaults to Mainnet | Require explicit CHAIN_ID |
| M7 | NEXT_PUBLIC_ Variable Exposure | Minimize client-side env exposure |

### 3.4 Attack Chains

**Chain 1: Complete Inbox Takeover (CRITICAL)**
1. Attacker finds alive agent from `/api/pulse-feed`
2. Obtains valid signature (replay or phishing)
3. POST `/api/inbox-key` â†’ receives bearer token
4. Read/write to victim's inbox

**Chain 2: RPC Cost Amplification DoS (HIGH)**
1. Monitor `x-cache` header for cache misses
2. Flood `/api/pulse-feed` at 30-second intervals
3. 252 RPC calls per request = massive cost

---

## 4. Access Control & Privilege Escalation (Agent 4)

### 4.1 Privilege Boundary Map

| Role | Capabilities | Risk Level |
|------|--------------|------------|
| **On-Chain Owner** | Full admin: TTL, minPulse, pause, hazard | ðŸ”´ GOD MODE |
| **Agent/Caller** | `pulse(amount)` only; self-state only | ðŸŸ¢ LIMITED |
| **API Consumer** | Unauthenticated read to status/feed | ðŸŸ¢ LIMITED |
| **Inbox Key Holder** | Read/write to specific wallet inbox | ðŸŸ¡ MEDIUM |
| **Inbox Admin** | Trigger cleanup (key/task deletion) | ðŸŸ¡ MEDIUM |
| **Vercel Env Admin** | Change RPC, contracts, secrets | ðŸ”´ HIGH |

### 4.2 Key Findings

#### F1: Owner Key Compromise = Protocol Kill Switch (HIGH)
- **Blast Radius:** Global
- **Attacks:** `setTTL(1)`, `setMinPulseAmount(1000e18)`, `pause()`, `updateHazard(agent, 100)`
- **Limitation:** No direct token theft (immutable burn sink)
- **Remediation:** Transfer to multisig (Safe) + timelock + emergency guardian

#### F3: No Timelock on Admin Operations (MEDIUM)
- **Concern:** All owner actions are immediate and globally effective
- **Remediation:** Add 24-48h timelock for parameter changes

#### F4: Deployer EOA Remains Owner if Transfer Never Happens (MEDIUM-HIGH)
- **Concern:** Single point of failure if ownership transfer skipped
- **Remediation:** Require ownership transfer as deployment checklist item

#### F6: API Privilege Model & Bearer Token Security (MEDIUM)
- **Concerns:** Tokens not bound to IP/session; in-memory caps bypassable
- **Remediation:** Hash keys (HMAC), constant-time compare, global throttling

#### F7: Vercel Env Vars Are High-Privilege Control Plane (HIGH)
- **Blast Radius:** Global UI/API integrity
- **Risks:** RPC URL changes, contract address swaps, secret exfiltration
- **Remediation:** Least-privilege Vercel roles, MFA, audit logging

#### F9: Social Engineering & Prompt Injection (MEDIUM-HIGH)
- **Risk:** Attacker with inbox key can inject malicious tasks
- **Remediation:** Strict schema validation, human approval for high-risk actions

---

## 5. Recon & Attack Surface (Agent 0)

### 5.1 Attack Surface Summary

| Domain | Key Assets | Primary Risk |
|--------|------------|--------------|
| **Contracts** | PulseRegistry.sol | Owner privilege abuse |
| **API** | 4 endpoints (status, feed, inbox-key, inbox) | Inbox auth bypass, RPC amplification |
| **Infrastructure** | Vercel, KV, RPC | Env var exposure, serverless fragmentation |
| **Economic** | PULSE token burn | Griefing via parameters |
| **Access Control** | Owner, bearer tokens, admin tokens | Privilege escalation |

### 5.2 Top 5 Exploitation Priorities (from Recon)

1. **ðŸ”´ CRITICAL** â€” Inbox Key Takeover: No wallet ownership verification
2. **ðŸ”´ HIGH** â€” Inbox Key DoS: Continuous key re-issuance overwrites valid keys
3. **ðŸŸ¡ HIGH** â€” RPC Amplification: Pulse-feed triggers massive RPC calls
4. **ðŸŸ¡ MEDIUM** â€” Liveness Oracle Divergence: `alive.ts` vs `PulseRegistry.isAlive()`
5. **ðŸŸ¡ MEDIUM** â€” In-Memory Store: Unbounded growth, volatility in serverless

---

## 6. Unified Risk Matrix

| Finding | Domain | Severity | Effort to Exploit | Business Impact |
|---------|--------|----------|-------------------|-----------------|
| Signature Replay Auth Bypass | API | ðŸ”´ CRITICAL | Low | Complete inbox compromise |
| SSRF via RPC URL | Infra | ðŸ”´ CRITICAL | Low | Internal network access |
| Owner Parameter Grief | Contract | ðŸ”´ HIGH | Low (requires key) | Protocol shutdown |
| Inbox Key Overwrite DoS | API | ðŸ”´ HIGH | Low | Inbox unavailability |
| RPC Amplification | API | ðŸ”´ HIGH | Low | Financial drain, API down |
| Throttling Bypass | Infra | ðŸ”´ HIGH | Medium | All API attacks amplified |
| Vercel Env Compromise | Infra | ðŸ”´ HIGH | Medium | Full backend compromise |
| Private Key in Env | Infra | ðŸŸ  HIGH | Medium | Deployer key exposure |
| No Timelock | Contract | ðŸŸ¡ MEDIUM | N/A | No response window |
| Retroactive TTL | Contract | ðŸŸ¡ MEDIUM | Low (requires key) | Unexpected agent death |
| XSS via Payload | API | ðŸŸ¡ MEDIUM | Medium | Stored XSS |
| Missing CORS/CSP | Infra | ðŸŸ¡ MEDIUM | Low | Increased attack surface |
| Oracle Divergence | Cross | ðŸŸ¡ MEDIUM | Medium | Auth confusion |

---

## 7. Consolidated Recommendations

### Immediate (P0 - Deploy Within 24 Hours)

| Priority | Action | Owner |
|----------|--------|-------|
| P0 | Fix inbox signature replay: Add EIP-712 with nonce + chainId | Backend |
| P0 | Remove NEXT_PUBLIC_ RPC fallback; add URL allowlist | Backend |
| P0 | Add global throttling (Redis/KV-based) | Backend |
| P0 | Add security headers (CSP, CORS, X-Frame-Options) | Infra |

### Short-term (P1 - Deploy Within 1 Week)

| Priority | Action | Owner |
|----------|--------|-------|
| P1 | Fix liveness oracle: Use contract `isAlive()` not Transfer events | Backend |
| P1 | Implement key rotation grace period + prevent overwrite abuse | Backend |
| P1 | Enforce synchronous task limits + payload size validation | Backend |
| P1 | Remove hardcoded defaults (CHAIN_ID, test keys) | DevOps |
| P1 | Transfer contract ownership to Safe multisig | Contract |

### Long-term (P2 - Deploy Within 1 Month)

| Priority | Action | Owner |
|----------|--------|-------|
| P2 | Add 24-48h timelock for parameter changes | Contract |
| P2 | Implement HSM/KMS for deployment keys | DevOps |
| P2 | Add comprehensive logging/monitoring | Infra |
| P2 | Formal verification of critical contract functions | Security |
| P2 | Implement challenge-response or EIP-1271 for contract wallets | Backend |

---

## 8. Conclusion

The Agent Pulse protocol demonstrates **strong fundamental security** in its smart contract design â€” reentrancy-safe, access-controlled, and economically resistant to value extraction. However, **critical vulnerabilities exist in the API authentication layer** and **infrastructure configuration** that could lead to complete inbox compromise and denial of service.

The most severe risk is the **owner key compromise** combined with **no timelock**, which allows instant protocol destruction. The second most severe is the **inbox authentication bypass**, which allows any attacker to read/write any alive agent's inbox.

**Recommendation:** Do not deploy to mainnet until P0 items are addressed and ownership is transferred to a multisig with timelock.

---

## Appendix A: Files Referenced

### Smart Contracts
- `packages/contracts/contracts/PulseRegistry.sol`
- `packages/contracts/test/PulseRegistryOwnerAbuse.t.sol` (new)

### API Routes
- `apps/web/src/app/api/inbox-key/route.ts`
- `apps/web/src/app/api/inbox/[wallet]/route.ts`
- `apps/web/src/app/api/pulse-feed/route.ts`
- `apps/web/src/app/api/status/[address]/route.ts`

### Libraries
- `apps/web/src/app/lib/inboxStore.ts`
- `apps/web/src/app/lib/rate[Limit].ts`
- `apps/web/src/app/lib/rpc.ts`
- `apps/web/src/app/lib/alive.ts`

### Configuration
- `apps/web/src/app/lib/env.server.ts`
- `apps/web/src/app/lib/env.public.ts`

---

*Report compiled by: Team B, Agent 1 (Security PR)*  
*Date: 2026-02-05*  
*Classification: INTERNAL USE ONLY*
